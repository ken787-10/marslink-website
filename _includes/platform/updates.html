<!-- Updates Section (Carousel) -->
<section id="updates" class="relative bg-gray-900 py-16 sm:py-20 lg:py-24" aria-labelledby="updates-heading">
    <div class="absolute inset-0 pointer-events-none" aria-hidden="true">
        <div class="absolute -top-20 right-0 h-48 w-48 rounded-full bg-cyan-500/10 blur-3xl"></div>
        <div class="absolute -bottom-24 left-10 h-40 w-40 rounded-full bg-blue-500/10 blur-3xl"></div>
    </div>

    <div class="relative mx-auto max-w-7xl px-6 lg:px-8">
        <div class="mx-auto max-w-4xl text-center">
            <h2 id="updates-heading" class="text-3xl font-bold tracking-tight text-white sm:text-4xl">更新情報</h2>
            <p class="mt-3 text-sm sm:text-base text-gray-400">最新のお知らせやリリース情報をお届けします。</p>
        </div>

        {% assign news_posts = site.posts | sort: 'date' | reverse %}

        {% if news_posts and news_posts.size > 0 %}
        <div class="mt-10 relative">
            <div id="updates-scroll" class="overflow-x-auto scrollbar-hide px-2 sm:px-4 snap-x snap-mandatory md:snap-none" style="scroll-behavior: smooth;">
                <div class="inline-flex gap-6 pb-4" data-track="updates-track" style="width: max-content;">
                    <div data-spacer-left="true" aria-hidden="true" class="shrink-0 md:hidden" style="width: max(0px, calc(50vw - 160px));"></div>
                    {% for post in news_posts limit:5 %}
                    {% assign thumb = post.image | default: post.thumbnail | default: '/assets/images/hero1.jpg' %}
                    {% assign img_src = thumb %}
                    {% if thumb contains '://' %}
                        {% assign img_src = thumb %}
                    {% else %}
                        {% assign img_src = thumb | relative_url %}
                    {% endif %}
                    <a href="{{ post.url | relative_url }}" class="updates-card group relative bg-gray-900 rounded-2xl overflow-hidden border border-gray-800 transition-all duration-300 flex flex-col flex-none shrink-0 snap-center focus:outline-none focus-visible:outline-none focus:ring-0" style="min-width: 320px; width: 320px;">
                        <div class="relative overflow-hidden" style="height: 0; padding-top: 75%;">
                            <img src="{{ img_src }}" alt="{{ post.title }}" class="absolute inset-0 w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">
                            <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-gray-900/50 to-transparent"></div>
                        </div>
                        <div class="relative p-6 flex-1 flex flex-col">
                            <div class="absolute inset-0 bg-gradient-to-br from-cyan-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div class="relative flex flex-col">
                                <time datetime="{{ post.date | date_to_xmlschema }}" class="text-sm text-gray-400 mb-2">{{ post.date | date: "%Y.%m.%d" }}</time>
                                <h3 class="text-lg font-bold text-white mb-3 whitespace-normal break-words">{{ post.title }}</h3>
                                {% if post.excerpt %}
                                <p class="text-gray-400 leading-relaxed text-sm whitespace-normal break-words">{{ post.excerpt | strip_html }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                    <div data-spacer-right="true" aria-hidden="true" class="shrink-0 md:hidden" style="width: max(0px, calc(50vw - 160px));"></div>
                </div>
            </div>

            <!-- Scroll Controls -->
            <button type="button" aria-label="前へ" class="absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-gray-900/90 backdrop-blur-sm border border-gray-700 rounded-full p-3 hover:bg-gray-800 transition-all opacity-75 hover:opacity-100" onclick="window.scrollUpdates && window.scrollUpdates(-1)">
                <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <button type="button" aria-label="次へ" class="absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-gray-900/90 backdrop-blur-sm border border-gray-700 rounded-full p-3 hover:bg-gray-800 transition-all opacity-75 hover:opacity-100" onclick="window.scrollUpdates && window.scrollUpdates(1)">
                <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="transform: scaleX(-1);">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
        </div>
        {% else %}
        <div class="mt-10">
            <div class="rounded-xl border border-white/10 bg-gray-900/60 p-6 text-center text-gray-400">まだ更新情報はありません。</div>
        </div>
        {% endif %}
    </div>

    <script>
    (function(){
        var container = document.getElementById('updates-scroll');
        if (!container) return;
        var track = container.querySelector('[data-track="updates-track"]');
        if (!track) return;

        var intervalMs = 3500; // スライド間隔
        var isHovered = false;
        var cards = container.querySelectorAll('.updates-card');
        if (!cards || cards.length === 0) return;

        var spacerLeft = track.querySelector('[data-spacer-left]');
        var spacerRight = track.querySelector('[data-spacer-right]');

        // 無限スクロール用に子要素（カードのみ）を複製
        (function cloneItems(){
            // 3件未満のときはクローンを作らず重複表示を避ける
            if (!cards || cards.length < 3) return;
            var originals = Array.from(track.children).filter(function(node){
                return !node.hasAttribute('data-spacer-left') && !node.hasAttribute('data-spacer-right');
            });
            originals.forEach(function(node){
                var clone = node.cloneNode(true);
                clone.setAttribute('aria-hidden','true');
                track.appendChild(clone);
            });
        })();

        // オリジナル幅（複製後は全体の半分が元コンテンツ）
        var originalCardsWidth = null;
        function computeOriginalCardsWidth(){
            var total = 0;
            var items = Array.from(track.children).filter(function(node){
                return node.classList && node.classList.contains('updates-card');
            }).slice(0, cards.length); // 複製分を除き元だけ
            if (items.length === 0) return 0;
            // gap は track のスタイルから取得
            var style = window.getComputedStyle(track);
            var gap = parseInt(style.columnGap || style.gap || '24', 10) || 24;
            items.forEach(function(el, idx){
                total += el.getBoundingClientRect().width;
                if (idx !== items.length - 1) total += gap;
            });
            return total;
        }

        function getOriginalWidth(){
            if (originalCardsWidth == null) originalCardsWidth = computeOriginalCardsWidth();
            return originalCardsWidth;
        }

        // 1枚の幅 + ギャップを推定（最初のカードから算出）
        function getStep(){
            var first = cards[0];
            var style = window.getComputedStyle(track);
            var gap = parseInt(style.columnGap || style.gap || '24', 10) || 24;
            return (first.getBoundingClientRect().width + gap);
        }

        // ホバーで一時停止
        container.addEventListener('mouseenter', function(){ isHovered = true; });
        container.addEventListener('mouseleave', function(){ isHovered = false; });
        var controls = document.querySelectorAll('#updates button');
        controls.forEach(function(btn){
            btn.addEventListener('mouseenter', function(){ isHovered = true; });
            btn.addEventListener('mouseleave', function(){ isHovered = false; });
        });

        function tick(){
            if (isHovered) return;
            var step = getStep();
            var originalWidth = getOriginalWidth();
            var leftPad = spacerLeft ? spacerLeft.getBoundingClientRect().width : 0;
            var current = container.scrollLeft - leftPad;
            var next = current + step;
            if (next >= originalWidth - 1) {
                // 先頭へシームレス復帰（PCではスナップ無効化済み）
                container.scrollTo({ left: leftPad, behavior: 'auto' });
            } else {
                container.scrollBy({ left: step, behavior: 'smooth' });
            }
        }

        // 初期位置: 最初のカードを中央に
        (function centerInitial(){
            var leftPad = spacerLeft ? spacerLeft.getBoundingClientRect().width : 0;
            container.scrollLeft = leftPad;
        })();

        // 自動スクロール開始
        setInterval(tick, intervalMs);

        // リサイズでステップや幅の計算を更新
        window.addEventListener('resize', function(){ originalCardsWidth = null; /* 再計算 */ });

        // 外部からの手動スクロール用
        window.scrollUpdates = function(direction){
            var dir = (typeof direction === 'number' ? direction : 1);
            var step = getStep();
            var originalWidth = getOriginalWidth();
            var leftPad = spacerLeft ? spacerLeft.getBoundingClientRect().width : 0;
            var current = container.scrollLeft - leftPad;
            if (dir > 0) {
                var next = current + step;
                if (next >= originalWidth - 1) {
                    container.scrollTo({ left: leftPad, behavior: 'auto' });
                    return;
                }
            }
            if (dir < 0 && container.scrollLeft <= leftPad) {
                // 先頭から左に行く場合は末尾（複製開始直前）へジャンプ
                container.scrollLeft = leftPad + originalWidth;
            }
            container.scrollBy({ left: step * dir, behavior: 'smooth' });
        };
    })();
    </script>
</section>


